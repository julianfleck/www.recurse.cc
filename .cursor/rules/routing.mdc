---
description: "Next.js App Router patterns and route organization"
globs: ["apps/**/app/**/*.{ts,tsx}"]
alwaysApply: false
lastVerified: 2025-01-27T00:00:00Z
sources:
  - name: "Next.js 15 App Router Research"
    url: "docs/research/2025-10-28/02-nextjs-15-patterns.md"
    accessedAt: 2025-10-28T02:55:29Z
---

# Next.js App Router Patterns

## Purpose

Standardize route organization and patterns across all apps in the recurse.cc monorepo. Focus on route groups, dynamic routes, middleware, and special files.

## Scope

All route files in:
- `apps/**/app/**/*.{ts,tsx}`

## Hard Requirements

### Route Groups

```typescript
// ✅ Good: Use route groups for organization and shared layouts
app/
  (dashboard)/              # Protected routes with shared layout
    layout.tsx              # Shared DocsLayout + ProtectedContent
    page.tsx                # / route (root)
    [...slug]/              # Required catch-all for MDX pages
      page.tsx              # /context, /other-mdx-pages
    context/
      page.tsx              # /context (React component route)
    usage/
      page.tsx              # /usage (inherits layout from route group)
  login/
    page.tsx                # /login (no layout, separate route)
```

**Critical patterns:**
- **Route groups** `(group-name)` don't affect URL but share layouts
- **All routes inside a route group** inherit the group's `layout.tsx`
- **Routes outside route groups** don't inherit layouts (e.g., `/login`, `/signup`)
- **Use route groups** for protected routes that need shared authentication/layout
- **Keep related routes together** in the same route group

### Dynamic Routes

```typescript
// ✅ Good: Dynamic segment
app/
  users/
    [id]/
      page.tsx         # /users/:id

// ✅ Good: Required catch-all (doesn't match root)
app/
  (dashboard)/
    [...slug]/
      page.tsx         # /context, /other (NOT /)

// ✅ Good: Optional catch-all (matches root too)
app/
  docs/
    [[...slug]]/
      page.tsx         # /docs and /docs/*

// ❌ Bad: Optional catch-all conflicts with root route
app/
  (dashboard)/
    page.tsx           # /
    [[...slug]]/       # ERROR: Conflicts with / route
      page.tsx
```

**Conventions:**
- `[slug]` - Required dynamic segment
- `[[...slug]]` - Optional catch-all (matches empty path too)
- `[...slug]` - Required catch-all (doesn't match empty path)

**Important:** Don't use `[[...slug]]` in the same route group as a `page.tsx` that handles the root. Use `[...slug]` instead to avoid route conflicts.

### Special Files

```typescript
// ✅ Good: Route-specific files
app/
  dashboard/
    page.tsx           # Page component
    layout.tsx        # Section layout
    loading.tsx       # Loading UI
    error.tsx         # Error boundary
    not-found.tsx     # 404 page
    route.ts          # API route
```

**File purposes:**
- `page.tsx` - Renders the page
- `layout.tsx` - Shared layout for route segment
- `loading.tsx` - Loading UI (Suspense boundary)
- `error.tsx` - Error boundary
- `not-found.tsx` - 404 page
- `route.ts` - HTTP route handler

### Route Handlers

```typescript
// ✅ Good: Named exports for HTTP methods
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  return NextResponse.json({ data: 'value' });
}

export async function POST(request: Request) {
  const body = await request.json();
  return NextResponse.json({ data: body });
}
```

- Export HTTP method functions (GET, POST, PUT, DELETE, PATCH)
- Return `Response` or `NextResponse`
- Access params via second argument

### Middleware

```typescript
// ✅ Good: Middleware for auth/protection
import { NextResponse } from 'next/server';

export function middleware(request: NextRequest) {
  const token = request.cookies.get('token');
  
  if (!token && request.nextUrl.pathname.startsWith('/dashboard')) {
    return NextResponse.redirect(new URL('/login', request.url));
  }
  
  return NextResponse.next();
}

export const config = {
  matcher: ['/dashboard/:path*'],
};
```

- Run before request completes
- Access to request/response
- Can redirect, rewrite, modify headers
- Configure matcher for route patterns

## Soft Guidelines

### Route Organization

```typescript
// ✅ Good: Logical nesting
app/
  dashboard/
    api-keys/
      page.tsx
    context/
      page.tsx
    settings/
      page.tsx
```

- Group related routes in folders
- Keep routes flat when possible
- Use layout.tsx for shared UI

### Parallel Routes

```typescript
// ✅ Good: Parallel routes with slots
app/
  dashboard/
    @analytics/
      page.tsx
    @team/
      page.tsx
    layout.tsx
```

- Use `@folder` for parallel routes
- Combined in layout.tsx
- Useful for multi-column layouts

### Route Separation

**Keep routes separate:**
- Public pages: `/`, `/docs`, `/blog`
- Auth pages: `/login`, `/signup`
- App pages: `/dashboard/*`

**Use route groups** to separate without affecting URLs.

## Monorepo Considerations

### Per-App Routing

Each app has its own routing concerns:

- **apps/www**: Marketing pages (`/`, `/product`, `/pricing`, `/blog`)
- **apps/docs**: Documentation (`/docs/*`)
- **apps/dashboard**: Application (`/dashboard/*`, `/login`, `/signup`)

### Shared Layouts

Avoid sharing layouts across apps (they're separate deployments).

### Cross-App Navigation

```typescript
// ✅ Good: Absolute URLs for cross-app links
<Link href="https://docs.recurse.cc/getting-started">
  Documentation
</Link>

// ✅ Good: Relative links within same app
<Link href="/dashboard/settings">
  Settings
</Link>
```

- Use absolute URLs for cross-app links
- Use relative links within same app

## Integration with Next.js

Follow next.mdc for:
- Server/Client Component patterns
- Data fetching in routes
- Metadata configuration

## Quality Checks

Before committing route changes:

- [ ] Route groups don't affect URLs
- [ ] Dynamic routes properly typed
- [ ] Special files used appropriately
- [ ] Middleware configured correctly
- [ ] Cross-app links use absolute URLs

## Dashboard App Specific Patterns

### Protected Routes with Route Groups

```typescript
// ✅ Good: Protected routes in route group
app/
  (dashboard)/
    layout.tsx              # Wraps with DocsLayout + ProtectedContent
    page.tsx                # Root page (MDX from content/dashboard/index.mdx)
    [...slug]/
      page.tsx              # MDX pages (content/dashboard/*.mdx)
    context/
      page.tsx              # React component route
    usage/
      page.tsx              # React component route (inherits layout)
```

**Key points:**
- **Route group `(dashboard)`** provides shared `DocsLayout` with sidebar
- **`ProtectedContent` wrapper** in layout handles authentication
- **All routes inside** `(dashboard)` get sidebar and protection
- **Routes outside** `(dashboard)` (like `/login`) don't get sidebar

### MDX Routing Pattern

```typescript
// Root route handles index.mdx
app/(dashboard)/page.tsx
  → dashboardSource.getPage([])
  → content/dashboard/index.mdx

// Catch-all handles other MDX files
app/(dashboard)/[...slug]/page.tsx
  → dashboardSource.getPage(['context'])
  → content/dashboard/context.mdx
```

**Requirements:**
- Root route (`page.tsx`) handles `index.mdx` with `getPage([])`
- Catch-all route (`[...slug]/page.tsx`) handles other MDX files
- Use **required catch-all** `[...slug]` not optional `[[...slug]]` to avoid conflicts
- Both routes use same `dashboardSource` and `DocsPage` components

### Authentication Pattern

```typescript
// ✅ Good: ProtectedContent in route group layout
app/(dashboard)/layout.tsx
export default function Layout({ children }) {
  return (
    <DocsLayout {...props}>
      <ProtectedContent>{children}</ProtectedContent>
    </DocsLayout>
  );
}
```

**Critical:** `ProtectedContent` must:
- Render children on server (so MDX content is in HTML)
- Show content during hydration (prevent flash)
- Only hide content when certain user isn't authenticated
- Never return `null` on server (breaks SSR)

## Exceptions

- **Fumadocs routes**: Follow fumadocs.mdc for MDX routing
- **Protected routes**: Use route groups with `ProtectedContent` wrapper
- **Auth pages**: Keep outside route groups (no sidebar needed)

## Proposed Changes

[Document friction as it emerges during use]
